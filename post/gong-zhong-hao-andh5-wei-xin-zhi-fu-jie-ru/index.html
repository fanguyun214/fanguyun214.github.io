<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>公众号&amp;H5微信支付接入 | Jason凡 Blog</title>
<meta name="description" content="🌱🌱🌱 每个人的生活都是一条通向自身的道路，找到自我，在心中坚守一生，全心全意，永不停息 🌱🌱🌱" />
<link rel="shortcut icon" href="https://fanguyun214.github.io/favicon.ico?v=1607064639579">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://fanguyun214.github.io/styles/main.css">

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144114666-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-144114666-1');
</script>


  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://fanguyun214.github.io">
  <img class="avatar" src="https://fanguyun214.github.io/images/avatar.png?v=1607064639579" alt="">
  </a>
  <h1 class="site-title">
    Jason凡 Blog
  </h1>
  <p class="site-description">
    🌱🌱🌱 每个人的生活都是一条通向自身的道路，找到自我，在心中坚守一生，全心全意，永不停息 🌱🌱🌱
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/fanguyun214" target="_blank">
          <i class="fab fa-github"></i>
        </a>
      
    
      
        <a href="https://twitter.com/home" target="_blank">
          <i class="fab fa-twitter"></i>
        </a>
      
    
      
        <a href="https://weibo.com/3307571020/profile" target="_blank">
          <i class="fab fa-weibo"></i>
        </a>
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              公众号&amp;H5微信支付接入
            </h2>
            <div class="post-info">
              <span>
                2019-12-03
              </span>
              <span>
                11 min read
              </span>
              
                <a href="https://fanguyun214.github.io/tag/8bpYHQpEF/" class="post-tag">
                  # 微信
                </a>
              
                <a href="https://fanguyun214.github.io/tag/VJa6GL78FP/" class="post-tag">
                  # 公众号
                </a>
              
                <a href="https://fanguyun214.github.io/tag/xUxaLbu8tX/" class="post-tag">
                  # 支付
                </a>
              
                <a href="https://fanguyun214.github.io/tag/OroaBJumjK/" class="post-tag">
                  # H5
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://fanguyun214.github.io/post-images/gong-zhong-hao-andh5-wei-xin-zhi-fu-jie-ru.png" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <p>商户在微信公众平台或开放平台提交微信支付申请，微信支付工作人员审核资料无误后开通相应的微信支付权限。微信支付申请审核通过后，商户在申请资料填写的邮箱中收取到由微信支付小助手发送的邮件，此邮件包含开发时需要使用的支付账户信息。</p>
<!-- more -->
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=3_1">支付账户说明</a></p>
<h3 id="支付接入流程">支付接入流程</h3>
<figure data-type="image" tabindex="1"><img src="https://fanguyun214.github.io/post-images/1578881317795.png" alt="" loading="lazy"></figure>
<h3 id="支付场景">支付场景</h3>
<h4 id="jsapi公众号支付">JSAPI（公众号支付）</h4>
<p>商户已有H5网站，用户通过消息或扫描二维码在微信内打开网页时，可以调用微信支付完成下单购买的流程<br>
只能从微信浏览器中发起<br>
可用微信浏览器内置方法，不需要引入微信jssdk<br>
<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_1">官方文档</a></p>
<h4 id="h5支付">H5支付</h4>
<p>H5支付是指商户在微信客户端外的移动端网页展示商品或服务，用户在前述页面确认使用微信支付时，<br>
商户发起本服务呼起微信客户端进行支付。主要用于触屏版的手机浏览器请求微信支付的场景。可以方便的从外部浏览器唤起微信支付<br>
支付配置：登录商户平台--&gt;产品中心--&gt;我的产品--&gt;支付产品→H5支付<br>
用户从非微信浏览器进入发起支付，不能从微信客户端调起<br>
要求商户已有H5商城网站，并且已经过ICP备案<br>
<a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_1">官方文档</a></p>
<hr>
<h3 id="jsapi支付公众号支付">JSAPI支付（公众号支付）</h3>
<p><strong>步骤一：添加开发者，微信授权登录配置</strong></p>
<p>添加开发者<br>
公众号登录管理后台，启用开发者中心，在开发者工具——web 开发者工具页面，向开发者微信号发送绑定邀请：<br>
<img src="https://fanguyun214.github.io/post-images/1575341547646.jpeg" alt="" loading="lazy"></p>
<p>微信授权登录<br>
开发者需要先到公众平台官网中的“开发 - 接口权限 - 网页服务 - 网页帐号 - 网页授权获取用户基本信息”的配置选项中，修改授权回调域名。这里填写的是域名（是一个字符串），而不是URL，因此请勿加 http:// 等协议头，授权回调域名配置规范为全域名，比如需要网页授权的域名 为：www.qq.com，配置以后此域名下面的页面http://www.qq.com/music.html 、 http://www.qq.com/login.html 都可以进行OAuth2.0鉴权。但http://pay.qq.com 、 http://music.qq.com 、 http://qq.com无法进行OAuth2.0鉴权。回调域名最多添加两个，需上传指定文件至回调域名根目录：<br>
<img src="https://fanguyun214.github.io/post-images/1575341597303.png" alt="" loading="lazy"></p>
<table>
<thead>
<tr>
<th>scope参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>snsapi_base</td>
<td>静默授权，获取openid，直接进入业务页面，用户无感知</td>
</tr>
<tr>
<td>snsapi_userinfo</td>
<td>需要用户手动同意，获取用户基本信息，对于已关注公众号的用户，如果用户从公众号的会话或者自定义菜单进入本公众号的网页授权页，即使是scope为snsapi_userinfo，也是静默授权，用户无感知</td>
</tr>
</tbody>
</table>
<p>具体而言，网页授权流程分为四步：</p>
<p>1、引导用户进入授权页面同意授权，获取code，接口示例:</p>
<pre><code>https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect
</code></pre>
<p>2、通过code换取网页授权access_token（与基础支持中的access_token不同）</p>
<p>3、如果需要，开发者可以刷新网页授权access_token，避免过期</p>
<p>4、通过网页授权access_token和openid获取用户基本信息（支持UnionID机制）</p>
<p>前端授权获取code后通过code调用后端接口获取用户信息，需要提供AppId，AppSecret</p>
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html">微信官方文档</a></p>
<p><strong>步骤二：设置支付域名与支付回调目录。</strong></p>
<p>在微信商户平台（pay.weixin.qq.com）设置您的JSAPI支付支付目录，设置路径：商户平台--&gt;产品中心→开发配置，JSAPI支付在请求支付的时候会校验请求来源是否有在商户平台做了配置，所以必须确保支付目录已经正确的被配置，否则将验证失败，请求支付不成功。</p>
<p>支付目录配置<br>
<img src="https://fanguyun214.github.io/post-images/1575341966467.png" alt="" loading="lazy"><br>
请求目录与设置目录必须一致，否则验证失败，支付不成功。</p>
<p><strong>步骤三：微信内调用支付可用微信浏览器内置方法（不需要引入微信jssdk）</strong>：</p>
<pre><code>if (typeof WeixinJSBridge === 'undefined') {
    if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
    } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
    }
} else {
    WeixinJSBridge.invoke(
        'getBrandWCPayRequest',
        {
        appId: newLevelOrder.appId,
        timeStamp: newLevelOrder.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
        nonceStr: newLevelOrder.nonceStr, // 支付签名随机串，不长于 32 位
        package: `prepay_id=${newLevelOrder.prePayId}`, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
        signType: 'MD5', // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
        paySign: newLevelOrder.paySign, // 支付签名
        },
        function(res: any) {
        if (res.err_msg === 'get_brand_wcpay_request:ok') {
            // 使用以上方式判断前端返回,微信团队郑重提示：
            //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
            // Toast.info('支付成功', 1, () =&gt; {});
            router.push('/package-buy/pay-success');
        } else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
            Toast.info('取消支付', 1);
        } else if (res.err_msg === 'get_brand_wcpay_request:fail') {
            // Toast.info('支付失败', 1);
            router.push(
            `/package-buy/pay-fail?name=${query.name}&amp;price=${query.h5Price}&amp;packid=${query.id}&amp;type=${query.type}`,
            );
        }
        },
    );
}
</code></pre>
<p>网页端接口请求参数列表（参数需要重新进行签名计算，参与签名的参数为：appId、timeStamp、nonceStr、package、signType，参数区分大小写与顺序。）<br>
调起支付请求参数由后端server调用统一下单接口返回，需提供AppId等。</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1">微信支付接口签名校验工具</a>，此工具旨在帮助开发者检测调用【微信支付接口API】时发送的请求参数中生成的签名是否正确。<br>
本地开发使用开发者工具，可用https://ngrok.com/做内网穿透，实现本地授权回调，支付调起需真机环境<br>
<a href="https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=2_2">微信平台与名词说明</a></p>
<hr>
<h3 id="h5支付接入">H5支付接入</h3>
<p>微信平台申请：登录微信商户平台--&gt;产品中心--&gt;我的产品--&gt;支付产品--&gt; H5支付<br>
<img src="https://fanguyun214.github.io/post-images/1575342323250.jpg" alt="" loading="lazy"><br>
申请流程：选择 H5支付--&gt;填写 H5 支付产品设置<br>
<img src="https://fanguyun214.github.io/post-images/1575342372576.jpg" alt="" loading="lazy"><br>
1）写入对应的支付域名（最多可添加5个），域名必须通过 ICP 备案；当域名备案主体与公司名称不一致，需要上传授权函（设置页面不支持直接上传）；上传方式：账户中心--&gt;企业账号--&gt;公司网站，输入网址，上传授权函（审核3-7个工作日）<br>
2）填写售卖场景/使用产品<br>
3）输入产品对应网站域名<br>
点击提交申请，页面提示审核时间为3-5个工作日（审核结果会反馈在消息中心）</p>
<p><strong>流程：</strong><br>
1、用户在商户侧完成下单，使用微信支付进行支付<br>
2、由商户后台向微信支付发起下单请求（调用统一下单接口）注：交易类型trade_type=MWEB<br>
3、统一下单接口返回支付相关参数给商户后台，如支付跳转url（参数名“mweb_url”），商户通过mweb_url调起微信支付中间页<br>
4、中间页进行H5权限的校验，安全性检查（此处常见错误请见下文）<br>
5、如支付成功，商户后台会接收到微信侧的异步通知<br>
6、用户在微信支付收银台完成支付或取消支付,返回商户页面（默认为返回支付发起页面）<br>
7、商户在展示页面，引导用户主动发起支付结果的查询<br>
8,9、商户后台判断是否接到收微信侧的支付结果通知，如没有，后台调用我们的订单查询接口确认订单状态<br>
10、展示最终的订单支付结果给用户</p>
<hr>
<h3 id="使用js-sdk实现公众号支付">使用JS-SDK实现公众号支付</h3>
<p><strong>步骤一： 在公众号后台配置相关参数“网页授权域名”、“JS接口安全域名”，在商户后台配置“支付授权目录”。</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>配置地址</th>
<th>意义</th>
<th>可配置个数</th>
</tr>
</thead>
<tbody>
<tr>
<td>网页授权域名</td>
<td>公众号后台-公众号设置-功能设置</td>
<td>在获取code的接口中配置的redirect_uri必须在这个域名下</td>
<td>2个</td>
</tr>
<tr>
<td>JS接口安全域名</td>
<td>公众号后台-公众号设置-功能设置</td>
<td>调用微信开放的JS接口的页面必须在此域名下</td>
<td>3个</td>
</tr>
<tr>
<td>支付授权目录</td>
<td>产品中心-开发配置-支付授权目录</td>
<td>调起微信支付的页面所在的目录</td>
<td>5个</td>
</tr>
</tbody>
</table>
<p><strong>步骤二：在需要调用JS接口的页面引入JS-SDK</strong>: <script src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>。</p>
<p><strong>步骤三：通过config接口注入权限验证配置。</strong></p>
<p>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用，目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复）。</p>
<pre><code>wx.config({
    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: '', // 必填，公众号的唯一标识
    timestamp: , // 必填，生成签名的时间戳
    nonceStr: '', // 必填，生成签名的随机串
    signature: '',// 必填，签名
    jsApiList: [] // 必填，需要使用的JS接口列表
});
</code></pre>
<p><strong>步骤四：通过ready接口处理成功验证、通过error接口处理失败验证。</strong></p>
<pre><code>wx.ready(function () {
    wx.checkJsApi({
        jsApiList: ['chooseWXPay'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
        success: function () {
        // 以键值对的形式返回，可用的api值true，不可用为false
        // 如：{&quot;checkResult&quot;:{&quot;chooseImage&quot;:true},&quot;errMsg&quot;:&quot;checkJsApi:ok&quot;}
        }
    });
});
</code></pre>
<p>config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</p>
<pre><code>wx.error(function(res){
    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开         config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
</code></pre>
<p><strong>步骤五：发起一个微信支付请求。</strong></p>
<pre><code>wx.chooseWXPay({
  timestamp: 0, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
  nonceStr: '', // 支付签名随机串，不长于 32 位
  package: '', // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
  signType: '', // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
  paySign: '', // 支付签名
  success: function (res) {
    // 支付成功后的回调函数
  }
});
</code></pre>
<p>参数通过统一下单接口拿到，paySign 采用统一的微信支付 Sign 签名生成方法，注意这里 appId 也要参与签名，appId 与 config 中传入的 appId 一致，即最后参与签名的参数有appId, timeStamp, nonceStr, package, signType。</p>
<p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html">JS-SDK使用文档</a></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5%E6%B5%81%E7%A8%8B">支付接入流程</a></li>
<li><a href="#%E6%94%AF%E4%BB%98%E5%9C%BA%E6%99%AF">支付场景</a>
<ul>
<li><a href="#jsapi%E5%85%AC%E4%BC%97%E5%8F%B7%E6%94%AF%E4%BB%98">JSAPI（公众号支付）</a></li>
<li><a href="#h5%E6%94%AF%E4%BB%98">H5支付</a></li>
</ul>
</li>
<li><a href="#jsapi%E6%94%AF%E4%BB%98%E5%85%AC%E4%BC%97%E5%8F%B7%E6%94%AF%E4%BB%98">JSAPI支付（公众号支付）</a></li>
<li><a href="#h5%E6%94%AF%E4%BB%98%E6%8E%A5%E5%85%A5">H5支付接入</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8js-sdk%E5%AE%9E%E7%8E%B0%E5%85%AC%E4%BC%97%E5%8F%B7%E6%94%AF%E4%BB%98">使用JS-SDK实现公众号支付</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://fanguyun214.github.io/post/superset-xin-zeng-tu-biao-lei-xing/">
              <h3 class="post-title">
                Superset新增图表类型
              </h3>
            </a>
          </div>
        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '94fca913faabe61337e0',
    clientSecret: '9ee8a359f64b424f77e6fba28063b59788b92af1',
    repo: 'fanguyun214.github.io',
    owner: 'fanguyun214',
    admin: ['fanguyun214'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
  Powered by Jasonfan & Grider  🖥 | 
  <a class="rss" href="https://fanguyun214.github.io/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()

  let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

  // This should probably be throttled.
  // Especially because it triggers during smooth scrolling.
  // https://lodash.com/docs/4.17.10#throttle
  // You could do like...
  // window.addEventListener("scroll", () => {
  //    _.throttle(doThatStuff, 100);
  // });
  // Only not doing it here to keep this Pen dependency-free.

  window.addEventListener("scroll", event => {
    let fromTop = window.scrollY;

    mainNavLinks.forEach((link, index) => {
      let section = document.getElementById(decodeURI(link.hash).substring(1));
      let nextSection = null
      if (mainNavLinks[index + 1]) {
        nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
      }
      console.log('section.offsetHeight', section.offsetHeight);
      if (section.offsetTop <= fromTop) {
        if (nextSection) {
          if (nextSection.offsetTop > fromTop) {
            link.classList.add("current");
          } else {
            link.classList.remove("current");    
          }
        } else {
          link.classList.add("current");
        }
      } else {
        link.classList.remove("current");
      }
    });
  });

</script>

      </div>
    </div>
  </body>
</html>
